description = "Xoom FeatherCon Servlet Container"

apply plugin: 'java'
apply plugin: 'jacoco'
apply plugin: 'maven-publish'

def btCredentialFile = new File(new File(System.getProperty("user.home"), ".gradle"), "bintray.gradle")
if (btCredentialFile.exists()) {
    apply from: file(btCredentialFile.getAbsolutePath())
}
if (!hasProperty("bintray")) {
    ext.bintray = [user: "", apikey: ""]
}

group = "com.xoom.oss"
version = "1.2.3"

buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath 'org.ajoberstar:gradle-jacoco:0.3.0'
    }
}

repositories {
    mavenCentral()
}

ext.versions = [
        intellij_annotations: "12.0",
        jersey: "1.17",
        junit: "4.11",
        logback: "1.0.13",
        slf4j: "1.7.5"
]

dependencies {
    compile "ch.qos.logback:logback-classic:${versions.logback}"
    compile "org.slf4j:jul-to-slf4j:${versions.slf4j}"
    compile 'org.eclipse.jetty:jetty-server:8.1.9.v20130131'
    compile 'org.eclipse.jetty:jetty-servlet:8.1.9.v20130131'
    compile 'org.eclipse.jetty.orbit:javax.servlet:3.0.0.v201112011016'
    compile group: "com.intellij", name: "annotations", version: versions.intellij_annotations

    testCompile group: "junit", name: "junit", version: versions.junit
    testCompile "org.hamcrest:hamcrest-all:1.3"
    testCompile "com.sun.jersey:jersey-core:${versions.jersey}"
    testCompile "com.sun.jersey:jersey-json:${versions.jersey}"
    testCompile "com.sun.jersey:jersey-server:${versions.jersey}"
    testCompile "com.sun.jersey:jersey-servlet:${versions.jersey}"
    testCompile "com.sun.jersey:jersey-client:${versions.jersey}"
}

tasks.withType(Test) {
    systemProperties = System.getProperties()
    jvmArgs '-Xmx2g'
    testLogging {
        showStandardStreams = true
        exceptionFormat "full"
    }
}

tasks.withType(Compile) {
    options.encoding = 'UTF-8'
    sourceCompatibility = targetCompatibility = 1.6
}

task wrapper(type: Wrapper) {
    gradleVersion = '1.7'
}

task sourceJar(type: Jar) {
    from sourceSets.main.allJava
}

publishing {
    publications {
        mavenJava(MavenPublication) {
            from components.java
            artifact sourceJar {
                classifier "sources"
            }
        }
    }

    repositories {
        maven {
            url "https://api.bintray.com/maven/xoom/xoomoss/feathercon"
            credentials {
                username = bintray.user
                password = bintray.apikey
            }
        }
    }
}

// http://forums.gradle.org/gradle/topics/_1_6_rc_1_jacoco_plugin_does_not_show_line_numbers
jacocoTestReport {
    group = "Reporting"
    description = "Generate Jacoco coverage reports after running tests."
    additionalSourceDirs = files(sourceSets.main.allJava.srcDirs)
}

